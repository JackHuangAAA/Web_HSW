<template>
    <div class="fingerAdd">
        <div class="fingerAdd-conent">
            <div class="fingerAdd-title">放置手指</div>
            <div class="fingerAdd-info">将手指放置在指纹仪上，识别完成后移开，并重复此步骤</div>
            <img src="/static/img/fingerEntry.png" alt="">
        </div>
        <div class="fingerAdd-footer">
            <div v-if="!noticeState" class="fingerAdd-notice">{{notice}}</div>
            <div v-if="noticeState" class="fingerAdd-succeed">
                <img src="/static/img/succeed.png" alt=""/>
                <div>指纹录入成功，请保存</div>
            </div>
        </div>
    </div>
</template>
<script>
import {mapGetters,mapActions} from 'vuex'
export default {
    data(){
        return{
            noticeState:false,//提示信息状态
            notice:'',
        }
    },
    computed:{
        ...mapGetters({
                user: 'user',
            }),
    },
    methods:{
        ...mapActions({
                saveUser: 'saveUser',
                saveDevice: 'saveDevice'
            }),
        // 指纹录入
        register(){
            this.$device.fingerRegister({userId:this.user._id})
        },
        //指纹数据更新
        async modifyUserById(params){
            let user=await this.$api.post('/user/modifyUserById',params)
        },
        test(){
            console.log(this.user.finger.length)
            
                this.noticeState=true
                let finger=this.user.finger
                finger.push('2')
                this.modifyUserById({id:this.user._id,finger:finger})
                if(this.user.finger.length<2){
                    console.log("录入第二次")
                    // this.register()
                    this.test()
                }else{
                    let to=setTimeout(()=>{
                        this.$emit('save',true)
                        clearTimeout(to)
                    },1500)
                }
        }
    },
    mounted(){
        // 设备反馈监听
        console.log("进入指纹打印")
        this.$device.subscribe('FINGER_MESSAGE', (data) => {
            this.notice=data.msg
            if(data.type==2){//type=1持续录入2完成
                this.noticeState=true
                let finger=this.user.finger
                finger.push('2')
                console.log("目前已有的指纹  =======》 result:"+finger)
                this.modifyUserById({id:this.user._id,finger:finger})
                if(finger.length<2){
                    console.log("录入第二次")
                    this.register()
                }else{
                    let to=setTimeout(()=>{
                        this.$emit('save',true)
                        clearTimeout(to)
                    },1500)
                }
            }else{
                this.noticeState=false
            }
        });
        // 执行指纹录入方法
        this.register()
    }
}
</script>
<style lang="less" scoped>
@import '~@/style/color.less';
@import '~@/style/fingerEntry.less';
</style>